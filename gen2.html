<html>
    <head>
        <style>
            .row{
                /*background-color: #555 !important;*/
            }
            .bordered{
                border-width: 1px;
                border-style: solid;
            }
            .cell{
                padding:0px;
                margin:0px;
                height:14vh;
            }
            .day{
                text-align: right;
                margin:0;
            }
            
            .input_cell{
                height:9vh;
            }
            .active-day{
                background-color:#FFF;
            }
            .inactive-day{
                background-color:#BBB;
            }
            .input_centered{
                text-align: center;
                padding-top:2vh;
            }
            .selected_button{
                background-color:#28A71A;
                background-image: none;
            }
            .work-day{
                cursor:pointer;
                background-color:#B5FFC6;
            }
            .day-off{
                cursor:pointer;
                background-color:#FFB4B4;
            }
            .crew-name{
                
            }
            .worker{
                margin:0!important;
                padding:0 !important;
            }
            #inputs{
                padding-top: 20px;
            }
            #shift{
                display: flex;
                justify-content: center;
            }
            #edit_day_off{
                margin-top: 20px;
                width:15vh;
            }
            #print{
                margin-top: 20px;
                width:15vh;
            }
            
        </style>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    </head>
    <body>
        <div class = "row" style = "margin:0;padding-left:5vh;padding-right:5vh;">
            <div class = "col-md-3" style = "height:90vh">
                <div class = "container cell">
                    <h4 style = "text-align: center;margin-top: 5vh;">Crew List:</h4>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>A:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>B:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>C</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>D:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>E:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>F:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>G:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row bordered">
                        <div class = "col input_cell">
                            <div class = "row input_centered">
                                <div class = "col-lg-2">
                                    <h3>H:</h3>
                                </div>
                                <div class = "col-lg-10">
                                    <span>
                                    </span>
                                    <input type = "text" class = "form-control crew-name" placeholder = "Crew Name">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "row">
                        <div class = "col" id = "shift">
                            <button id = "edit_day_off" class = "btn btn-outline-info" >Edit Day Offs</button>
                        </div>
                        <!--
                        <div class = "col" id = "shift">
                            <button id = "print" class = "btn btn-outline-info" >Print</button>
                        </div>
                        -->
                    </div>
                    
                </div>
            </div>
            <div class = "col-md-9">
                <h1 id = "month" style="text-align: center"></h1>
                <div class = "container-fluid" id = "calendar">
                    <div class = "row">
                        <div class = "col">
                            <h5 style = "text-align: center">Monday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Tuesday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Wednesday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Thursday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Friday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Saturday</h5>
                        </div>
                        <div class = "col">
                            <h5 style = "text-align: center">Sunday</h5>
                        </div>
                    </div>
                </div>  
                <div class = "row">
                        <div class ="col">
                            G - Graveyard
                        </div>
                        <div class ="col">
                            M - Morning
                        </div>
                        <div class ="col">
                            A - Afternoon
                        </div>
                    </div>
            </div>
        </div>
        
    </body>
    <script>
        //template
        function crew(name, off){
            this.name = name; 
            this.off = off;
            this.prev_day = -1;
            this.g_count = 8;
            this.m_count = 8;
            this.a_count = 8;
            this.g = 0;
            this.m = 0;
            this.a = 0;
            this.isLeader = false;
            
            this.toString = function(){
                return this.name + " gc:" + this.g_count +
                    "\nmc:" + this.m_count +
                    "\nac:" + this.a_count +
                    "\n G: " + this.g + " M: " + this.m + " A: " + this.a;
            }
        }
        
        function day(day){
            this.graveyard = [];
            this.morning = [];
            this.afternoon = [];
            this.day = day;
            
            this.getAvailable = function(aw){
                var arr = [];
                arr.push(0);
                arr.push(0);
                arr.push(0);
                for(var i = 0 ; i < aw.length ; i ++){
                    arr[0] += (aw[i].g_count>0?1:0);
                    arr[1] += (aw[i].m_count>0?1:0);
                    arr[2] += (aw[i].a_count>0?1:0);
                }
                return arr;
            }
            
            this.assign_workers = function(curr){
                var g = 1;
                var m = 1;
                var a;
                if(curr.length >= 7)
                    a = 2;
                else
                    a = 1;
                
                var avail = this.getAvailable(curr);
                while(g>=0){
                    var ind = -1;
                    var c = null;
                    for(var i = 0 ; i < curr.length ; i++){
                        var t = curr[i];
                        if(t.g_count>0&&(avail[1]-2>0?true:(t.m_count==0))&&(avail[2]-(a+1)>0?true:(t.a_count==0))){
                            ind= i;
                            c = curr[ind];
                            break;
                        }
                    }
                    for(var i = 0 ; i < curr.length; i++){
                        var temp = curr[i];
                        if((temp.g_count < c.g_count || temp.g < 6) && (c.g_count>0?temp.g_count>0:false) && (avail[1]-2>0?true:(temp.m_count==0))&&(avail[2]-(a+1)>0?true:(temp.a_count==0))){
                            ind = i;
                            c = temp;
                            break;
                        }
                    }
                    curr.splice(ind, 1);
                    c.g_count--;
                    if(c.g_count==0) c.g_count = 9;
                    c.g++;
                    c.prev_day = 1;
                    this.graveyard.push(c);
                    g--;
                    avail = this.getAvailable(curr);
                }
                avail = this.getAvailable(curr);
                while(m>=0){
                    var ind = -1;
                    var c = null;
                    for(var i = 0 ; i < curr.length ; i++){
                        var t = curr[i];
                        if(t.m_count>0 &&(avail[2]-(a+1)>0?true:(t.a_count==0)) && t.prev_day!= 1){
                            ind= i;
                            c= curr[ind];
                            break;
                        }
                    }
                    for(var i = 0 ; i < curr.length; i++){
                        var temp = curr[i];
                        if((temp.m_count < c.m_count || temp.m < 5) && (c.m_count > 0?temp.m_count>0:false) && (avail[2]-(a+1)>0?true:(temp.a_count==0))&&temp.prev_day!=1){
                            ind = i;
                            c = temp;
                            break;
                        }
                    }
                    //console.log(c.name + " < selected");
                    curr.splice(ind, 1);
                    c.m_count--;
                    c.m++;
                    if(c.m_count==0)c.m_count = 9;
                    this.morning.push(c);
                    c.prev_day = 2;
                    m--;
                    avail = this.getAvailable(curr);
                }
                
                
                avail = this.getAvailable(curr);
                while(a>=0){
                    var ind = -1;
                    var c = null;
                    for(var i = 0 ; i < curr.length ; i++){
                        var t = curr[i];

                        if(t.a_count>0){
                            ind= i;
                            c= curr[ind];
                            break;
                        }
                    }
                    for(var i = 0 ; i < curr.length; i++){
                        var temp = curr[i];
                        if((temp.a_count < c.a_count || temp.a < 5) && (c.a_count>0?temp.a_count>0:false)){
                            ind = i;
                            c = temp;
                            break;
                        }
                    }
                    curr.splice(ind, 1);
                    c.a_count--;
                    c.a++;
                    if(c.a_count==0)c.a_count = 9;
                    this.afternoon.push(c);
                    c.prev_day = 3;
                    a--;
                }
            }
        }
        //template
        
        function convert(x){
            switch(x){
                case 'A':
                    return 0;
                case 'B':
                    return 1;
                case 'C':
                    return 2;    
                case 'D':
                    return 3;    
                case 'E':
                    return 4;    
                case 'F':
                    return 5;    
                case 'G':
                    return 6;    
                case 'H':  
                    return 7;
                case 0:
                    return 'A';
                case 1:
                    return 'B';
                case 2:
                    return 'C';    
                case 3:
                    return 'D';    
                case 4:
                    return 'E';    
                case 5:
                    return 'F';    
                case 6:
                    return 'G';    
                case 7:
                    return 'H';    
            }
            return 0;
        }
        
        function isAvailable(off, date){
            for(var i = 0 ; i < crew_off[off].length ; i++){
                if(crew_off[i] == date) return false;
            }
            return true;
        }
        
        /*
        *
        *
        *       INITIALIZATION
        *
        *
        */
        var crew_off = Cookies.getJSON("crew_off");
        var crew_list = [];
        
        for(var i = 0 ; i < 8 ; i++){
            //crew_list.push(new crew(convert(i),[i]));
            crew_list.push(new crew(convert(i),crew_off[i]));
        }
        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September","October", "November", "December"];
        
        var calendar = $("#calendar");
        var td = new Date();
        var last_day = new Date(td.getYear(),td.getMonth()+1%12,0).getDate();
        var offset = new Date(td.getYear(),td.getMonth()+1%12,1).getDay();
        $("#month").text(months[td.getMonth()]);
        var curr_date = 1;  
        
        for(var i = 0 ; i < 6 ; i++){
            var row = $("<div>");
            row.addClass("row");
            
            for(var k = 0 ; k < 7 ; k++){
                var col = $("<div>");
                col.addClass("col cell bordered inactive-day");
                col.html("<p class = 'day'></p>");
                row.append(col);
            }
            calendar.append(row);
        }
        var work_month = [];
        while(curr_date!=last_day+1){
            
            working = [];
            //console.log("$$$$$$$$$$$$$$$$$$" + curr_date);
            for(var k = 0; k < 8 ; k++){
				var c = crew_list[k];
                var valid = true;
                for(var i = 0 ; i < c.off.length ; i++){
                    if(c.off[i] == curr_date){
                        valid = false;
                        c.prev_day = -1;
                        break;
                    }
                }
				if(valid) working.push(c);
			}
            var n = new day(curr_date);
            n.assign_workers(working);
            work_month.push(n);
            var cont = $("<div>");
            cont.addClass("container worker");
            
            var r1 = $("<div>");
            r1.addClass("row");
            var r2 = $("<div>");
            r2.addClass("row");
            var r3 = $("<div>");
            r3.addClass("row");
            
            var c1 = $("<div>");
            c1.addClass("col");
            var c2 = $("<div>");
            c2.addClass("col");
            var c3 = $("<div>");
            c3.addClass("col");
            
            c1.append("G: ");
            c2.append("M: ");
            c3.append("A: ");
            
            for(var i = 0 ; i < n.graveyard.length ; i++){
                c1.append("<b>"+n.graveyard[i].name+"<b>");
                if(i!=n.graveyard.length-1) c1.append(", ");
            }
            for(var i = 0 ; i < n.morning.length ; i++){
                c2.append("<b>"+n.morning[i].name+"<b>");
                if(i!=n.morning.length-1) c2.append(", ");
            }
            for(var i = 0 ; i < n.afternoon.length ; i++){
                c3.append("<b>"+n.afternoon[i].name+"<b>");
                if(i!=n.afternoon.length-1) c3.append(", ");
            }
            
            
            r1.append(c1);
            r2.append(c2);
            r3.append(c3);
            cont.append(r1);
            cont.append(r2);
            cont.append(r3);
            var col = calendar.children()[Math.ceil((curr_date + offset)/7)].children[(curr_date+offset-1)%7];
            var p = col.firstChild;
            $(col).append(cont);
            p.innerHTML = curr_date;
            col.classList.remove("inactive-day");
            col.classList.add("active-day");
            curr_date++;
        }
        for(var i = 0 ; i < crew_list.length ; i++){
            console.log(crew_list[i].toString());
        }
        
        /*
        *
        *
        *       INITIALIZATION
        *
        *
        */
        
        $("#edit_day_off").click(function(){
            window.location.href = "index.html";
        });
        $("#print").click(function(){
            var css = '@page { size: landscape; }',
            head = document.head || document.getElementsByTagName('head')[0],
            style = document.createElement('style');

            style.type = 'text/css';
            style.media = 'print';

            if (style.styleSheet){
              style.styleSheet.cssText = css;
            } else {
              style.appendChild(document.createTextNode(css));
            }

            head.appendChild(style);

            window.print();
        });
    </script>
</html>